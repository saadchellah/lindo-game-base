<!DOCTYPE HTML>
<html>

<head>
    <!-- ================================================================
             ðŸ”¥ CONSOLIDATED DEVICE SPOOFING (All phases combined)
             ================================================================ -->
    <script>

        // ================================================================
        // PHASE 1: CRITICAL HARDWARE SPOOFING (Must be FIRST!)
        // ================================================================
        
        // âœ… CRITICAL: Match EXACT RAM from real device (4GB = 4,294,967,296 bytes)
        Object.defineProperty(navigator, 'deviceMemory', {
            get: () => 4,
            configurable: true,
            enumerable: true
        });

        // âœ… CRITICAL: Set connection type for performance reports
        Object.defineProperty(navigator, 'connection', {
            get: () => ({
                type: 'wifi',
                effectiveType: '4g',
                downlink: 10,
                rtt: 50,
                saveData: false,
                onchange: null
            }),
            configurable: true,
            enumerable: true
        });

        // âœ… CRITICAL: Low-end CPU: 4 cores (budget processor)
        Object.defineProperty(navigator, 'hardwareConcurrency', {
            get: () => 4,
            configurable: true,
            enumerable: true
        });

        Object.defineProperty(navigator, 'platform', {
            get: () => 'Linux armv8l',
            configurable: true
        });

        // ================================================================
        // PHASE 1B: CLIENT HINTS API SPOOFING (Dynamic from User-Agent)
        // ================================================================

        // âœ… Get device info from parent Electron process (parsed from User-Agent)
        const deviceInfo = window.top.gameContext?.deviceInfo || {
            androidVersion: "9",
            androidVersionFull: "9.0.0",
            sdkVersion: 28,
            model: "SM-A105FN",
            manufacturer: "samsung",
            brand: "samsung",
            product: "a10",
            buildId: "PQ3A.190905.001",
            incremental: "PQ3A.190905.001",
            chromeVersion: "138",
            chromeVersionFull: "138.0.7204.181"
        };

        Object.defineProperty(navigator, 'userAgentData', {
            get: () => ({
                brands: [
                    { brand: "Android WebView", version: deviceInfo.chromeVersion },
                    { brand: "Chromium", version: deviceInfo.chromeVersion },
                    { brand: "Not?A_Brand", version: "8" }
                ],
                mobile: true,
                platform: "Android",
                getHighEntropyValues: async (hints) => {
                    return {
                        brands: [
                            { brand: "Android WebView", version: deviceInfo.chromeVersion },
                            { brand: "Chromium", version: deviceInfo.chromeVersion },
                            { brand: "Not?A_Brand", version: "8" }
                        ],
                        fullVersionList: [
                            { brand: "Android WebView", version: deviceInfo.chromeVersionFull },
                            { brand: "Chromium", version: deviceInfo.chromeVersionFull },
                            { brand: "Not?A_Brand", version: "8.0.0.0" }
                        ],
                        mobile: true,
                        platform: "Android",
                        platformVersion: deviceInfo.androidVersionFull,
                        architecture: "",
                        bitness: "",
                        model: deviceInfo.model,
                        uaFullVersion: deviceInfo.chromeVersionFull,
                        wow64: false,
                        formFactors: ["Mobile"]
                    };
                },
                toJSON: () => ({
                    brands: [
                        { brand: "Android WebView", version: deviceInfo.chromeVersion },
                        { brand: "Chromium", version: deviceInfo.chromeVersion },
                        { brand: "Not?A_Brand", version: "8" }
                    ],
                    mobile: true,
                    platform: "Android"
                })
            }),
            configurable: true,
            enumerable: true
        });

        Object.defineProperty(navigator, 'maxTouchPoints', {
            get: () => 5,
            configurable: true
        });

        // âœ… CRITICAL: Inject chrome.system.memory API for RAM capacity reporting
        if (!window.chrome) {
            window.chrome = {};
        }
        if (!window.chrome.system) {
            window.chrome.system = {};
        }
        window.chrome.system.memory = {
            getInfo: function (callback) {
                // Return exact RAM capacity from real device (4GB = 4,294,967,296 bytes)
                callback({
                    capacity: 4294967296,
                    availableCapacity: 4294967296 * 0.6  // ~60% available
                });
            }
        };

        // ================================================================
        // PHASE 2: GPU SPOOFING (Before any WebGL context creation)
        // ================================================================
        
        const getParam = WebGLRenderingContext.prototype.getParameter;
        const getParam2 = WebGL2RenderingContext?.prototype?.getParameter;

        const spoofHandler = function (parameter) {
            // GPU identity - Adreno (TM) 506 (SM-A105FN low-end GPU)
            if (parameter === 37445) return 'Qualcomm';
            if (parameter === 37446) return 'Adreno (TM) 506';

            // WebGL version strings
            if (parameter === 7938) return 'WebGL 1.0 (OpenGL ES 2.0 Chromium)';
            if (parameter === 35724) return 'WebGL GLSL ES 1.0 (OpenGL ES 2.0 Chromium)';
            if (parameter === 7936) return 'WebKit';
            if (parameter === 7937) return 'WebKit WebGL';

            // GPU capabilities (lower for budget device)
            if (parameter === 3379) return 4096;   // MAX_TEXTURE_SIZE (lower)
            if (parameter === 34024) return 8192;  // MAX_RENDERBUFFER_SIZE (lower)

            return getParam.call(this, parameter);
        };

        WebGLRenderingContext.prototype.getParameter = spoofHandler;
        if (getParam2) {
            WebGL2RenderingContext.prototype.getParameter = spoofHandler;
        }

        // ================================================================
        // PHASE 3: SCREEN & WINDOW SPOOFING (Before DOM ready)
        // ================================================================
        
        // Lower resolution screen (640x360) - SM-A105FN
        Object.defineProperties(screen, {
            width: { get: () => 640, configurable: true, enumerable: true },
            height: { get: () => 360, configurable: true, enumerable: true },
            availWidth: { get: () => 640, configurable: true, enumerable: true },
            availHeight: { get: () => 360, configurable: true, enumerable: true },
            colorDepth: { get: () => 24, configurable: true },
            pixelDepth: { get: () => 24, configurable: true }
        });

        // Device pixel ratio
        Object.defineProperty(window, 'devicePixelRatio', {
            get: () => 3,
            configurable: true
        });

        // Window dimensions
        Object.defineProperty(window, 'innerWidth', {
            get: () => 640,
            configurable: true
        });

        Object.defineProperty(window, 'innerHeight', {
            get: () => 360,
            configurable: true
        });

        function getOrCreateUUID() {
            var uuid = localStorage.getItem('lindo_device_uuid');
            if (!uuid) {
                // Generate 16-character hex UUID
                uuid = 'xxxxxxxxxxxxxxxx'.replace(/x/g, function () {
                    return Math.floor(Math.random() * 16).toString(16);
                });
                localStorage.setItem('lindo_device_uuid', uuid);
            }
            return uuid;
        }

        var deviceUUID = getOrCreateUUID();

        // Application name for alert dialogs (from init.js)
        window.APPLICATION_NAME_DISPLAY = 'Dofus Touch';

        // Touch fix
        window.ontouchstart = function (e) { };

        // Init
        window.buildVersion = window.top.buildVersion;
        window.appVersion = window.top.appVersion;
        window.appInfo = {
            version: window.appVersion
        };

        window._ = {
            appVersion: window.appVersion,
            buildVersion: window.buildVersion,
            client: "android"
        };

        // Fake IndexedDB
        window.indexedDB = window.indexedDB || {};
        window.IDBDatabase = window.IDBDatabase || {};
        window.IDBTransaction = window.IDBTransaction || {};
        window.IDBCursor = window.IDBCursor || {};
        window.IDBKeyRange = window.IDBKeyRange || {};

        // Intercept IndexedDB.deleteDatabase() to fake success (browser lock bypass)
        if (window.indexedDB && window.indexedDB.deleteDatabase) {
            window.indexedDB.deleteDatabase = function() {
                var req = { onsuccess: null };
                setTimeout(() => req.onsuccess?.({ target: req }), 100);
                return req;
            };
        }

        // ================================================================
        // CORDOVA PLUGINS & DEVICE INFO
        // ================================================================
        
        // âœ… Device Info - Dynamically generated from parsed User-Agent
        window.device = {
            model: deviceInfo.model,
            platform: 'Android',
            uuid: deviceUUID,
            version: deviceInfo.androidVersion,
            manufacturer: deviceInfo.manufacturer,
            isVirtual: false,
            serial: 'unknown',
            brand: deviceInfo.brand,
            product: deviceInfo.product,
            device: deviceInfo.product,
            hardware: 'exynos9810',
            sdkVersion: deviceInfo.sdkVersion,
            host: 'unknown',
            incremental: deviceInfo.incremental,
            fingerprint: `${deviceInfo.brand}/${deviceInfo.product}/${deviceInfo.product}:${deviceInfo.androidVersion}/${deviceInfo.incremental}/AB234567:user/release-keys`
        };

        // Cordova Plugins
        window.cordova = {
            platformId: 'android',
            platformVersion: deviceInfo.androidVersionFull,
            version: deviceInfo.androidVersionFull,
            plugins: {
                device: {
                    getInfo: function (success) {
                        success(window.device);
                    }
                },
                isemulator: {
                    assess: function (callback) { callback(false); }
                },
                Keyboard: {
                    close: function () { },
                    disableScroll: function () { },
                    show: function () { },
                    hideKeyboardAccessoryBar: function () { }
                },
                notification: {
                    local: {
                        schedule: function () { },
                        cancel: function () { },
                        clear: function () { }
                    }
                },
                pushNotification: {
                    onDeviceReady: function () { },
                    setUserId: function () { },
                    registerDevice: function () { }
                },
                sim: {
                    getSimInfo: function (success, error) {
                        // Permission denied - READ_PHONE_STATE not granted
                        error('Permission denied: READ_PHONE_STATE');
                    },
                    hasReadPermission: function (success, error) {
                        // Simulate permission revoked (Android 6.0+)
                        success(false);
                    },
                    requestReadPermission: function (success, error) {
                        // User denies permission request
                        error('Permission request denied by user');
                    }
                },
                network: {
                    getConnectionInfo: function (success) {
                        success({ type: 'wifi' });
                    }
                },
                deviceMotion: {
                    getCurrentAcceleration: function (success) {
                        success({ x: 0.01, y: -0.02, z: 9.81 });
                    }
                },
                splashscreen: {
                    hide: function () { },
                    show: function () { }
                }
            }
        };

        // Extra Cordova globals
        window.StatusBar = {
            hide: function () { },
            show: function () { },
            styleDefault: function () { },
            styleLightContent: function () { },
            styleBlackTranslucent: function () { }
        };

        window.plugins = window.cordova.plugins;

        // Store original alert before overriding
        var originalAlert = window.alert.bind(window);

        // Navigator notification API (required for custom alert override)
        if (!window.navigator.notification) {
            window.navigator.notification = {
                alert: function (message, alertCallback, title, buttonName) {
                    // Use original browser alert
                    originalAlert(message);
                    if (alertCallback) alertCallback();
                },
                confirm: function (message, confirmCallback, title, buttonLabels) {
                    var result = window.confirm(message);
                    if (confirmCallback) confirmCallback(result ? 1 : 2);
                },
                prompt: function (message, promptCallback, title, buttonLabels, defaultText) {
                    var result = window.prompt(message, defaultText);
                    if (promptCallback) promptCallback({ buttonIndex: result ? 1 : 2, input1: result || '' });
                }
            };
        }

        // Custom alert override (from init.js)
        window.alert = function (msg) {
            window.navigator.notification.alert(msg, null, window.APPLICATION_NAME_DISPLAY, 'Ok');
        };

        // ================================================================
        // UTILITY FUNCTIONS
        // ================================================================
        
        // macOS RAF fix
        if (window.top.platform == "darwin") {
            (function () {
                window.requestAnimationFrame = function (callback) {
                    var self = requestAnimationFrame;
                    self.queue.push(callback);
                    if (!self.timeout) {
                        self.timeout = setTimeout(function () {
                            var queue = self.queue;
                            self.queue = [];
                            self.timeout = null;
                            queue.forEach(function (q) { q(); });
                        }, 16);
                    }
                };
                requestAnimationFrame.queue = [];
                requestAnimationFrame.timeout = null;
            })();
        }

        // Game init
        window.initDofus = function (cb) {
            var head = document.getElementsByTagName('head')[0];
            var scriptScript = document.createElement('script');
            scriptScript.addEventListener('load', function () {
                var fixesScript = document.createElement('script');
                fixesScript.src = 'fixes.js';
                head.appendChild(fixesScript);
                cb();
            });
            scriptScript.src = 'build/script.js';
            head.appendChild(scriptScript);
        };
    </script>

    <meta charset="utf-8">
    <title>Dofus Touch</title>

    <!-- Security & Mobile Meta Tags (from real Android game) -->
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="transparent">
    <meta name="msapplication-tap-highlight" content="no">

    <!-- Content Security Policy (CSP) - Adapted for Electron -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' http: https: data: wss: ws: file: 'unsafe-eval' 'unsafe-inline'; object-src 'none'">

    <link rel="stylesheet" href="build/styles-native.css" />
    <link rel="stylesheet" href="fixes.css" />
</head>

<body>
</body>
<script src="keymaster2.js"></script>

</html>

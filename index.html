<html>

<head>
    <meta charset="utf-8">
    <title>Dofus Touch</title>
    <!-- ================================================================
             ðŸ”¥ PHASE 1: CRITICAL HARDWARE SPOOFING (Must be FIRST!)
             ================================================================ -->
    <script>
        'use strict';
        // âœ… Low-end device: 4GB RAM
        Object.defineProperty(navigator, 'deviceMemory', {
            get: () => 4,  // 4GB RAM (budget phone)
            configurable: true,
            enumerable: true
        });

        // âœ… Connection type
        Object.defineProperty(navigator, 'connection', {
            get: () => ({
                type: 'wifi',
                effectiveType: '4g',
                downlink: 8,
                rtt: 60,
                saveData: false,
                onchange: null
            }),
            configurable: true,
            enumerable: true
        });

        // âœ… Low-end CPU: 4 cores
        Object.defineProperty(navigator, 'hardwareConcurrency', {
            get: () => 4,  // 4 cores (budget processor)
            configurable: true,
            enumerable: true
        });

        Object.defineProperty(navigator, 'platform', {
            get: () => 'Linux armv8l',
            configurable: true
        });

        Object.defineProperty(navigator, 'maxTouchPoints', {
            get: () => 5,
            configurable: true
        });

        // âœ… Chrome memory API: 4GB = 4,294,967,296 bytes
        if (!window.chrome) {
            window.chrome = {};
        }
        if (!window.chrome.system) {
            window.chrome.system = {};
        }
        window.chrome.system.memory = {
            getInfo: function (callback) {
                callback({
                    capacity: 4294967296,  // 4GB in bytes
                    availableCapacity: Math.round(4294967296 * 0.5)  // ~50% available
                });
            }
        };

        console.log('[Lindo] Phase 1: Hardware spoofing (Low-end device)');
        console.log('[Lindo] - RAM: 4GB, Cores: 4');

        // PHASE 2: GPU SPOOFING (Budget GPU)

        const getParam = WebGLRenderingContext.prototype.getParameter;
        const getParam2 = WebGL2RenderingContext?.prototype?.getParameter;

        const spoofHandler = function (parameter) {
            // Budget GPU: Adreno 506
            if (parameter === 37445) return 'Qualcomm';
            if (parameter === 37446) return 'Adreno (TM) 506';

            // WebGL version strings
            if (parameter === 7938) return 'WebGL 1.0 (OpenGL ES 2.0 Chromium)';
            if (parameter === 35724) return 'WebGL GLSL ES 1.0 (OpenGL ES 2.0 Chromium)';
            if (parameter === 7936) return 'WebKit';
            if (parameter === 7937) return 'WebKit WebGL';

            // Lower GPU capabilities
            if (parameter === 3379) return 4096;   // MAX_TEXTURE_SIZE (lower)
            if (parameter === 34024) return 8192;  // MAX_RENDERBUFFER_SIZE (lower)

            return getParam.call(this, parameter);
        };

        WebGLRenderingContext.prototype.getParameter = spoofHandler;
        if (getParam2) {
            WebGL2RenderingContext.prototype.getParameter = spoofHandler;
        }

        console.log('[Lindo] Phase 2: GPU spoofed - Qualcomm Adreno 506');

        // PHASE 3: SCREEN & WINDOW SPOOFING (Lower resolution)

        Object.defineProperties(screen, {
            width: { get: () => 640, configurable: true, enumerable: true },
            height: { get: () => 360, configurable: true, enumerable: true },
            availWidth: { get: () => 640, configurable: true, enumerable: true },
            availHeight: { get: () => 360, configurable: true, enumerable: true },
            colorDepth: { get: () => 24, configurable: true },
            pixelDepth: { get: () => 24, configurable: true }
        });

        // Device pixel ratio
        Object.defineProperty(window, 'devicePixelRatio', {
            get: () => 3,
            configurable: true
        });

        // Window dimensions
        Object.defineProperty(window, 'innerWidth', {
            get: () => 640,
            configurable: true
        });

        Object.defineProperty(window, 'innerHeight', {
            get: () => 360,
            configurable: true
        });

        // Lower JS Heap limits for budget device
        if (window.performance?.memory) {
            const origMemory = window.performance.memory;
            Object.defineProperty(window.performance, 'memory', {
                get: () => ({
                    get jsHeapSizeLimit() { return 536870912; },  // 512MB heap limit
                    get totalJSHeapSize() {
                        return Math.min(origMemory.totalJSHeapSize || 50000000, 50000000);
                    },
                    get usedJSHeapSize() {
                        return Math.min(origMemory.usedJSHeapSize || 45000000, 45000000);
                    }
                }),
                configurable: true
            });
        }

        console.log('[Lindo] Phase 3: Screen 640x360 @ DPR 3, Heap 512MB');

        // PHASE 4: DEVICE UUID & CORDOVA SETUP

        function getOrCreateUUID() {
            var uuid = localStorage.getItem('lindo_device_uuid');
            if (!uuid) {
                // Generate 16-character hex UUID
                uuid = 'xxxxxxxxxxxxxxxx'.replace(/x/g, function () {
                    return Math.floor(Math.random() * 16).toString(16);
                });
                localStorage.setItem('lindo_device_uuid', uuid);
                console.log('[Lindo] Generated NEW device UUID:', uuid);
            } else {
                console.log('[Lindo] Using EXISTING device UUID:', uuid);
            }
            return uuid;
        }

        var deviceUUID = getOrCreateUUID();

        // Touch fix
        window.ontouchstart = function (e) { };

        // Init
        window.buildVersion = window.top.buildVersion;
        window.appVersion = window.top.appVersion;
        window.appInfo = {
            version: window.top.appVersion
        };

        window._ = {
            appVersion: window.appVersion,
            buildVersion: window.buildVersion,
            client: "android"
        };

        // Fake IndexedDB (use defineProperty to avoid read-only errors)
        if (!window.indexedDB) {
            try {
                Object.defineProperty(window, 'indexedDB', {
                    value: {},
                    writable: true,
                    configurable: true
                });
            } catch (e) {
                console.warn('[Lindo] IndexedDB already defined:', e.message);
            }
        }
        window.IDBDatabase = window.IDBDatabase || {};
        window.IDBTransaction = window.IDBTransaction || {};
        window.IDBCursor = window.IDBCursor || {};
        window.IDBKeyRange = window.IDBKeyRange || {};

        // Cordova Plugins
        window.cordova = {
            platformId: 'android',
            platformVersion: '14.0.1',
            version: '14.0.1',
            plugins: {
                device: {
                    getInfo: function (success) {
                        success(window.device);
                    }
                },
                isemulator: {
                    assess: function (callback) { callback(false); }
                },
                Keyboard: {
                    close: function () { },
                    disableScroll: function () { },
                    show: function () { },
                    hideKeyboardAccessoryBar: function () { }
                },
                notification: {
                    local: {
                        schedule: function () { },
                        cancel: function () { },
                        clear: function () { }
                    }
                },
                pushNotification: {
                    onDeviceReady: function () { },
                    setUserId: function () { },
                    registerDevice: function () { }
                },
                sim: {
                    getSimInfo: function (success, error) {
                        success({
                            carrierName: 'Orange',
                            countryCode: 'ma',
                            mcc: '604',
                            mnc: '01',

                            // All other fields intentionally empty / absent for privacy
                            simSerialNumber: '',   // empty string
                            subscriptionId: null,  // numeric field -> null (use 1 if the app requires a number)
                            phoneNumber: null      // null is most realistic for "no number available"
                        });
                    }
                },
                network: {
                    getConnectionInfo: function (success) {
                        success({ type: 'wifi' });
                    }
                },
                deviceMotion: {
                    getCurrentAcceleration: function (success) {
                        success({ x: 0.01, y: -0.02, z: 9.81 });
                    }
                },
                splashscreen: {
                    hide: function () { },
                    show: function () { }
                }
            }
        };

        // Device Info
        window.device = {
            cordova: '14.0.1',
            model: 'SM-G998U',
            platform: 'Android',
            uuid: deviceUUID,
            version: '9',
            manufacturer: 'samsung',
            isVirtual: false,
            serial: 'unknown',  // unknown for privacy
            brand: 'samsung',
            product: 'a10',
            device: 'a10',
            hardware: 'exynos7884B',  // Exynos chipset
            sdkVersion: 28,  // Android 9 = SDK 28
            host: 'SWDD5610',
            incremental: 'A105FDDU4CUH1',
            fingerprint: 'samsung/a10dd/a10:9/PPR1.180610.011/A105FDDU4CUH1:user/release-keys'
        };

        // Extra Cordova globals
        window.StatusBar = {
            hide: function () { },
            show: function () { },
            styleDefault: function () { },
            styleLightContent: function () { },
            styleBlackTranslucent: function () { }
        };

        window.plugins = window.cordova.plugins;

        // macOS RAF fix
        if (window.top.platform == "darwin") {
            (function () {
                window.requestAnimationFrame = function (callback) {
                    var self = requestAnimationFrame;
                    self.queue.push(callback);
                    if (!self.timeout) {
                        self.timeout = setTimeout(function () {
                            var queue = self.queue;
                            self.queue = [];
                            self.timeout = null;
                            queue.forEach(function (q) { q(); });
                        }, 16);
                    }
                };
                requestAnimationFrame.queue = [];
                requestAnimationFrame.timeout = null;
            })();
        }

        // Game init
        window.initDofus = function (cb) {
            console.log('[Lindo] initDofus called');
            var head = document.getElementsByTagName('head')[0];
            var scriptScript = document.createElement('script');
            scriptScript.addEventListener('load', function () {
                console.log('[Lindo] script.js loaded');
                var fixesScript = document.createElement('script');
                fixesScript.src = 'fixes.js';
                fixesScript.addEventListener('load', function () {
                    console.log('[Lindo] fixes.js loaded');
                    cb();
                });
                fixesScript.addEventListener('error', function (e) {
                    console.error('[Lindo] Failed to load fixes.js:', e);
                    cb(); // Call callback anyway to prevent hanging
                });
                head.appendChild(fixesScript);
            });
            scriptScript.addEventListener('error', function (e) {
                console.error('[Lindo] Failed to load script.js:', e);
            });
            scriptScript.src = 'build/script.js';
            head.appendChild(scriptScript);
        };
        console.log('[Lindo] âœ… ALL SPOOFING COMPLETE - initDofus defined:', typeof window.initDofus);

    </script>

    <link rel="stylesheet" href="build/styles-native.css" />
    <link rel="stylesheet" href="fixes.css" />
</head>

<body>
</body>
<script src="keymaster2.js"></script>

</html>
